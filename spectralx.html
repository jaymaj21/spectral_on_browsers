<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Spectral</title>
<style>@font-face{font-family:OpenDyslexic;src:url('https://jm21.s3.us-east-1.amazonaws.com/static_pages/opendyslexicmono-regular-webfont.woff2') format('woff2');font-weight:400;font-style:small}@font-face{font-family:OpenDyslexicMono;src:url('https://jm21.s3.us-east-1.amazonaws.com/static_pages/opendyslexicmono-regular-webfont.woff2') format('woff2');font-weight:400;font-style:small}body{font-family:Arial,sans-serif;margin:20px}.cursor{display:inline-block;width:1px;background-color:#00f;animation:blink 1s step-end infinite;vertical-align:text-bottom;height:1em}.searchResultsListing{max-height:300px;max-width:500px;overflow-y:auto;overflow-x:auto;padding-right:8px}@keyframes blink{from,to{opacity:1}50%{opacity:0}}.toolbar{border:1px solid #ccc;padding:5px;background:#f3f3f3}.toolbars{position:sticky;top:0;z-index:100}.editor{font-family:'Courier New',Courier,monospace;border:1px solid #ccc;min-height:600px;padding:10px;margin-top:5px;outline:0;width:100%;height:100%;box-sizing:border-box;overflow:auto;white-space:pre-wrap;word-break:break-word;overflow-wrap:break-word}.toolbar button,input[type=text],select{margin-right:5px}.highlight1{background-color:#f0f583}.highlight2{background-color:#fd9f9f}.highlight3{background-color:#aafba2}.highlight4{background-color:#a5f8f8}.highlight5{background-color:#f997f9}.highlight6{background-color:#ccddf7}.highlight7{background-color:#fff}#searchBox1{background-color:#f0f583;width:150px}#searchBox2{background-color:#fd9f9f;width:150px}#searchBox3{background-color:#aafba2;width:150px}#searchBox4{background-color:#a5f8f8;width:150px}#searchBox5{background-color:#f997f9;width:150px}#searchBox6{background-color:#ccddf7;width:150px}#searchBox7{background-color:#fff;width:150px}.hlButton{width:20px}#hlButton1{background-color:#f0f583}#hlButton2{background-color:#fd9f9f}#hlButton3{background-color:#aafba2}#hlButton4{background-color:#a5f8f8}#hlButton5{background-color:#f997f9}#hlButton6{background-color:#ccddf7}#hlButton7{background-color:#fff}#boldButton{font-weight:700}#italicsButton{font-style:italic}#underlineButton{text-decoration:underline}#statusBar{padding:0;border:1px solid #ccc}#statusText{width:100%;height:100%;resize:none;border:none;padding:4px;font-family:monospace;background:#f9f9f9;color:#333}.note-button{width:24px;height:24px;background-color:#ffeb3b;border:1px solid #999;border-radius:4px;cursor:pointer;font-size:14px;line-height:1;text-align:center;padding:0}@media print{body,html{height:auto!important;overflow:visible!important}.toolbars{display:none}}</style>
</head>
<body>
<div class=toolbars id=top_toolbars>
<div class=toolbar>
<input type=file id=fileLoader title="Open file ...">
<button onclick=execBold() id=boldButton title="Boldface the selection">B</button>
<button onclick=execItalic() id=italicsButton title="Italicize the selection">I</button>
<button onclick=execUnderline() id=underlineButton title="Underline the selection">U</button>
<button onclick=removeBold() id=removeBoldButton title="Remove boldface from selection">¬B</button>
<button onclick=removeItalics() id=removeItalicsButton title="Remove italics from selection">¬I</button>
<button onclick='removeUnderline("editor")' id=removeUnderlineButton title="Remove underline from selection">¬U</button>
<button onclick='firstHalfBoldWords("editor")' title="Make left half of words bold faced"><strong>Bo</strong>ld</button>
<button onclick='secondHalfBoldWords("editor")' title="Make right half of words bold faced">Bo<strong>ld</strong></button>
<button onclick=target() title="Set target">🎯</button>
<button onclick=link() title="Create link to target">[🔗]</button>
<button onclick=xlink() title="Create external link">ext🔗</button>
<button onclick='execCmd("removeFormat")' title="Clear highlighting/formatting from selection">Clear Formatting</button>
<input type=color id=editorBgColor title="Editor Background Color" value=#ffffff>
<button onclick=setDefaultFont() title="Set default font and size">𝒟ℱ</button>
<button onclick=copyEditorToClipboard() title="Copy editor content to clipboard">📋 Copy</button>
<button onclick=showAWSConfigPopup() title="Configure S3 details">S3 🔧🔑</button>
<button onclick=promptAndSaveToS3() title="Save to S3 storage">💾 Save to S3</button>
<button onclick=promptAndLoadFromS3() title="Load from S3 storage">📂 Load from S3</button>
<button title="Clean up MathML" onclick=tidyUp()>🧹 MathML</button>
</div>
<div class=toolbar>
<select id=fontChooser title="Font for highlighters">
<option value="No Selection">No Font Selection</option>
<option value=Arial>Arial</option>
<option value=Verdana>Verdana</option>
<option value="Times New Roman">Times New Roman</option>
<option value="Courier New">Courier New</option>
<option value=OpenDyslexic>OpenDyslexic</option>
<option value=OpenDyslexicMono>OpenDyslexicMono</option>
</select>
<select id=sizeChooser title="Font size for highlighters">
<option value=0 selected>No Size Selection</option>
<option value=1>Small</option>
<option value=3>Normal</option>
<option value=5>Large</option>
<option value=7>Huge</option>
</select>
<input type=color id=colorChooser title="Forground color for highlighters" value=#000000>
<label>
<input type=checkbox id=editableToggle checked onchange=toggleEditable(this.checked)>
Editable
</label>
<label>
<input type=checkbox id=wrapToggle checked onchange=toggleLineWrap(this.checked)>
Wrap lines
</label>
<label>
<input type=checkbox id=caseInsensitive checked>Ignore Case</label>
<button onclick=showFindReplaceDialog() title="Find and replace">🔍 Find & Replace</button>
<button onclick=speakSelection() title="Read aloud the selected text">🗣 Speak Selection</button>
<button id=toggleCursorModeBtn onclick=toggleCursorInsertMode() title="Add cursors to selection or interactively add cursors">🖱 Add n-Cursors</button>
<button onclick=clearAllCursors() title="Clear all cursors">❌ Clear n-Cursors</button>
<button onclick=alignWithCursors() id=alignWithCursorsBtn style="font-size:.8em;padding:2px 6px">Align /w Cursors ⬅️</button>
<button onclick=sanitizeHtml() title=Sanitize>🧼</button>
<button onclick=help() title="Help screen">❓ Help</button>
</div>
<div class=toolbar>
<input id=searchBox1 placeholder="Enter regex, press enter">
<button id=hlButton1 class=hlButton> 🖍️</button>
<input id=searchBox2 placeholder="Enter regex, press enter">
<button id=hlButton2 class=hlButton> 🖍️</button>
<input id=searchBox3 placeholder="Enter regex, press enter">
<button id=hlButton3 class=hlButton> 🖍️</button>
<input id=searchBox4 placeholder="Enter regex, press enter">
<button id=hlButton4 class=hlButton> 🖍️</button>
<input id=searchBox5 placeholder="Enter regex, press enter">
<button id=hlButton5 class=hlButton> 🖍️</button>
<input id=searchBox6 placeholder="Enter regex, press enter">
<button id=hlButton6 class=hlButton> 🖍️</button>
<input id=searchBox7 placeholder="Enter regex, press enter">
<button id=hlButton7 class=hlButton> 🖍️</button>
<label> <input type=checkbox id=showSearchResults>Results</label>
</div>
<div class=toolbar id=statusBar>
<textarea id=statusText rows=2 readonly></textarea>
</div>
</div>
<br>
<div id=editor class=editor contenteditable=true></div>
<script src=https://sdk.amazonaws.com/js/aws-sdk-2.1485.0.min.js></script>
<script>const isMac=/Mac/i.test(navigator.platform);let textPopupCallback=null,savedEditorRange=null;function ctrlAltEquivalent(e){return e.ctrlKey&&e.altKey||isMac&&e.metaKey}var currentFixedHighlighter=null;function setHighlighterCursor(e){if(null==e)document.body.style.cursor="auto";else{const t=encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M2,22 L4,14 L18,2 L22,6 L10,20 Z" fill="'+e+'" stroke="#444" stroke-width="1"/><path d="M2,22 L6,18" stroke="#444" stroke-width="2"/></svg>').replace(/'/g,"%27").replace(/"/g,"%22");document.body.style.cursor='url("data:image/svg+xml,'+t+'") 2 22, auto'}}function sethl(e){currentFixedHighlighter=null!=e?e:null,setHighlighterCursor(e)}function sethlwhite(){sethl("#ffffff")}function execCmd(e,t=null){document.execCommand(e,!1,t)}function execItalic(){(null==savedEditorRange||savedEditorRange.collapsed)&&(italicsMode=!italicsMode,document.getElementById("italicsButton").style.borderColor=italicsMode?"#ff0000":""),applyInlineStyle({fontStyle:"italic"},"editor")}let boldMode=!1,italicsMode=!1,underlineMode=!1,removeBoldMode=!1,removeItalicsMode=!1,removeUnderlineMode=!1;function execBold(){(null==savedEditorRange||savedEditorRange.collapsed)&&(boldMode=!boldMode,document.getElementById("boldButton").style.borderColor=boldMode?"#ff0000":""),applyInlineStyle({fontWeight:"bold"},"editor")}function execUnderline(){(null==savedEditorRange||savedEditorRange.collapsed)&&(underlineMode=!underlineMode,document.getElementById("underlineButton").style.borderColor=underlineMode?"#ff0000":""),applyInlineStyle({textDecoration:"underline solid"},"editor")}function execHilite(e){styles={backgroundColor:e},augmentFontWeightStyleAndDecoration(styles),applyInlineStyle(styles,"editor")}function toggleFixedHighlighterWhenEmptySelection(e,t){if(null!=e){for(var n=1;n<=7;++n)document.getElementById("hlButton"+n).style.borderColor="";null==currentFixedHighlighter?(t.style.borderColor="#ff0000",currentFixedHighlighter=e):currentFixedHighlighter=null,setHighlighterCursor(currentFixedHighlighter)}}function applyInlineStyle(e,t,n=null){const o=document.getElementById(t),r=savedEditorRange;if(null==r||!o.contains(r.commonAncestorContainer))return;const s=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=document.createRange();return t.selectNodeContents(e),r.compareBoundaryPoints(Range.END_TO_START,t)<0&&r.compareBoundaryPoints(Range.START_TO_END,t)>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);let l;const a=[];for(;l=s.nextNode();)a.push(l);const i=[];a.forEach((e=>{const t=document.createRange();t.selectNodeContents(e);const n=t.cloneRange();n.setStart(e,e===r.startContainer?r.startOffset:0),n.setEnd(e,e===r.endContainer?r.endOffset:e.length),i.push({node:e,spanStart:n.startOffset,spanEnd:n.endOffset})})),i.sort(((e,t)=>{if(e.node===t.node)return t.spanStart-e.spanStart;return e.node.compareDocumentPosition(t.node)&Node.DOCUMENT_POSITION_PRECEDING?1:-1})),i.forEach((({node:t,spanStart:o,spanEnd:r})=>{if(o===r)return;const s=document.createElement("span");null!=n&&(s.className="highlight"+n),Object.keys(e).forEach((t=>{s.style[t]=e[t]}));const l=document.createRange();l.setStart(t,o),l.setEnd(t,r),"textDecoration"in e&&""==e.textDecoration&&removeUnderlineHelper("editor",l),l.surroundContents(s)})),window.getSelection().removeAllRanges()}var dark=!1;function getEditorHTML(){const e=document.getElementById("editor").innerHTML;return alert("Editor HTML:\n"+e),e}function setEditorHTML(){const e=prompt("Paste HTML content here:");null!==e&&(document.getElementById("editor").innerHTML=e)}function applyHighlightAndFont(e,t=!0,n=null){const o=document.getElementById("colorChooser").value,r=document.getElementById("fontChooser").value,s=document.getElementById("sizeChooser").value;if(styles={},(!t||"rgb(255, 255, 255)"!==e.toLowerCase()&&"rgb(0, 0, 0)"!==e.toLowerCase())&&(styles.backgroundColor=e),styles.color=o,"No Selection"!==r&&(styles.fontFamily=r),"No Selection"!==s)switch(s){case"1":styles.fontSize="x-small";break;case"3":default:styles.fontSize="medium";break;case"5":styles.fontSize="x-large";break;case"7":styles.fontSize="xx-large"}augmentFontWeightStyleAndDecoration(styles),applyInlineStyle(styles,"editor",n)}function augmentFontWeightStyleAndDecoration(e){boldMode&&(e.fontWeight="bold"),italicsMode&&(e.fontStyle="italic"),underlineMode&&(e.textDecoration="underline solid"),removeBoldMode&&(e.fontWeight="normal"),removeItalicsMode&&(e.fontStyle="normal"),removeUnderlineMode&&(e.textDecoration="")}function registerEventHandlers(e){0!=e&&(document.getElementById("searchBox"+e).addEventListener("keypress",(function(t){var n=document.getElementById("showSearchResults").checked;"Enter"===t.key&&highlightRegexRobust(t.target.value,e,n)})),document.getElementById("hlButton"+e).addEventListener("click",(function(t){if(t.ctrlKey)openColorPickerForButton(e);else{var n=window.getComputedStyle(t.target).backgroundColor;const o=window.getSelection();if(0===o.rangeCount||o.isCollapsed)return void toggleFixedHighlighterWhenEmptySelection(n,t.target);applyHighlightAndFont(n,!0,e)}})),registerEventHandlers(e-1))}function rgbToHex(e){const t=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(!t)return"#000000";return`#${parseInt(t[1]).toString(16).padStart(2,"0")}${parseInt(t[2]).toString(16).padStart(2,"0")}${parseInt(t[3]).toString(16).padStart(2,"0")}`}function openColorPickerForButton(e){const t=document.getElementById("hlButton"+e),n=document.getElementById("searchBox"+e),o=document.createElement("input");o.type="color",o.value=rgbToHex(getComputedStyle(t).backgroundColor),o.style.position="absolute",o.style.left="-9999px",document.body.appendChild(o),o.addEventListener("input",(()=>{const e=o.value;t.dataset.color=e,t.style.backgroundColor=e,n.dataset.color=e,n.style.backgroundColor=e})),o.addEventListener("change",(()=>{setStatus(`Highlighter color updated to ${o.value}`),document.body.removeChild(o)})),o.click()}function randomHilightColor(){var e=dark?"23456":"BCDEF";let t="#";for(let n=0;n<6;n++)t+=e[Math.floor(Math.random()*e.length)];return t}function highlightRegexRobust(e,t,n=!1){const o=document.getElementById("editor"),r=document.getElementById("caseInsensitive")?.checked,s=r?"gim":"gm",l=new RegExp(e.length<=3?"\\b"+e+"\\b":e,s),a=randomHilightColor(),i=(document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1),[]);let c="",d=0;var u=null,g=null,m=0;n&&t>=1&&t<=7&&(u=document.getElementById("searchResults"+t+"listing"),g=document.getElementById("searchResults"+t),u.innerHTML="",g.style.display="block",makeDraggable("searchResults"+t,"searchResults"+t+"Header"),u.addEventListener("copy",copyHandler),hideTools());const f=[];let p;for(!function e(t){if(t.nodeType===Node.TEXT_NODE){const e=t.textContent;e.trim().length>0&&i.push({node:t,start:d,end:d+e.length}),c+=e,d+=e.length}else if(t.nodeType===Node.ELEMENT_NODE||t.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const n=t.tagName?.toLowerCase();["div","p","li","tr","br"].includes(n)&&(c+="\n",d++);for(const n of t.childNodes)e(n);["div","p","li","tr"].includes(n)&&(c+="\n",d++)}}(o);null!==(p=l.exec(c));){const e=p.index,t=p.index+p[0].length;i.forEach((({node:n,start:o,end:r})=>{if(r<=e||o>=t)return;const s=Math.max(o,e)-o,l=Math.min(r,t)-o;f.push({node:n,spanStart:s,spanEnd:l})}))}f.sort(((e,t)=>e.node===t.node?t.spanStart-e.spanStart:i.indexOf(t.node)-i.indexOf(e.node))),f.forEach((({node:e,spanStart:o,spanEnd:r})=>{const s=document.createRange(),l=document.createElement("span");if(l.className=0===t?"highlight":"highlight"+t,t>=1&&t<=7&&(l.style.backgroundColor=document.getElementById("searchBox"+t).style.backgroundColor),s.setStart(e,o),s.setEnd(e,r),n&&t>=1&&t<=7){const e=`srch_${generateGUID()}`;l.id=e;var i=getTextFromRangeEndToNextNewline(s),c=getTextFromLastNewlineToRangeStart(s);++m,u.appendChild(document.createTextNode("#"+m+"\t"+escapeTextWithLineBreaks(c.substr(-40))));const t=document.createElement("a");t.href=`#${e}`,t.innerText=s.toString(),t.style.display="inline",t.setAttribute("onclick","selectText('"+e+"')"),u.appendChild(t),u.appendChild(document.createTextNode(escapeTextWithLineBreaks(i.substr(0,40)))),u.appendChild(document.createElement("br"))}if(0===t)l.style.backgroundColor=a;else{boldMode&&(l.style.fontWeight="bold"),italicsMode&&(l.style.fontStyle="italic"),underlineMode&&(l.style.textDecoration="underline solid"),removeBoldMode&&(l.style.fontWeight="normal"),removeItalicsMode&&(l.style.fontStyle="normal");const e=document.getElementById("colorChooser").value,t=document.getElementById("fontChooser").value,n=document.getElementById("sizeChooser").value;if(l.style.color=e,"No Selection"!==t&&(l.style.fontFamily=t),"No Selection"!==n)switch(n){case"1":l.style.fontSize="x-small";break;case"3":default:l.style.fontSize="medium";break;case"5":l.style.fontSize="x-large";break;case"7":l.style.fontSize="xx-large"}removeUnderlineMode&&removeUnderlineHelper("editor",s)}s.surroundContents(l)})),setStatus(`${f.length} match(es) for pattern: ${e}`)}function escapeTextWithLineBreaks(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\r\n/g,"<br/>").replace(/\n/g,"<br/>")}registerEventHandlers(7),document.getElementById("editor").addEventListener("dblclick",(function(e){const t=window.getSelection().toString().trim();t.length>0&&highlightRegexRobust(t,0,!1)}));let currentFileName=null;function secondHalfBoldWords(e){!function e(t){if(t.nodeType===Node.TEXT_NODE){const e=t.textContent.split(/(\s+)/),n=document.createDocumentFragment();e.forEach((e=>{if(e.trim().length>3){const t=Math.floor(e.length/2),o=e.slice(0,t),r=e.slice(t);n.appendChild(document.createTextNode(o));const s=document.createElement("strong");s.textContent=r,n.appendChild(s)}else n.appendChild(document.createTextNode(e))})),t.replaceWith(n)}else t.nodeType===Node.ELEMENT_NODE&&Array.from(t.childNodes).forEach(e)}(document.getElementById(e))}function firstHalfBoldWords(e){!function e(t){if(t.nodeType===Node.TEXT_NODE){const e=t.textContent.split(/(\s+)/),n=document.createDocumentFragment();e.forEach((e=>{if(e.trim().length>3){const t=Math.ceil(e.length/2),o=e.slice(0,t),r=e.slice(t),s=document.createElement("strong");s.textContent=o,n.appendChild(s),n.appendChild(document.createTextNode(r))}else n.appendChild(document.createTextNode(e))})),t.replaceWith(n)}else t.nodeType===Node.ELEMENT_NODE&&Array.from(t.childNodes).forEach(e)}(document.getElementById(e))}function toggleEditable(e){const t=document.getElementById("editor");t.contentEditable=e?"true":"false",t.style.backgroundColor=e?"#ffffff":"#fafafa"}function removeBold(){(null==savedEditorRange||savedEditorRange.collapsed)&&(removeBoldMode=!removeBoldMode,document.getElementById("removeBoldButton").style.borderColor=removeBoldMode?"#ff0000":""),applyInlineStyle({fontWeight:"normal"},"editor")}function removeItalics(){(null==savedEditorRange||savedEditorRange.collapsed)&&(removeItalicsMode=!removeItalicsMode,document.getElementById("removeItalicsButton").style.borderColor=removeItalicsMode?"#ff0000":""),applyInlineStyle({fontStyle:"normal"},"editor")}function removeUnderline(e){removeUnderlineHelper(e,savedEditorRange)}function removeUnderlineHelper(e,t){if(null==t||t.collapsed)return removeUnderlineMode=!removeUnderlineMode,void(document.getElementById("removeUnderlineButton").style.borderColor=removeUnderlineMode?"#ff0000":"");const n=document.getElementById(e),o=t;if(!n.contains(o.commonAncestorContainer))return;const r=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{if(!o.intersectsNode(e))return NodeFilter.FILTER_REJECT;return window.getComputedStyle(e).textDecorationLine.includes("underline")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}),s=[];let l;for(;l=r.nextNode();)s.push(l);s.forEach((e=>{if(e.style.textDecoration="none",!e.getAttribute("style")||""===e.getAttribute("style").trim()){const t=e.parentNode;for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)}})),window.getSelection().removeAllRanges()}function toggleLineWrap(e){const t=document.getElementById("editor");t&&(e?(t.style.whiteSpace="pre-wrap",t.style.overflowX="hidden"):(t.style.whiteSpace="pre",t.style.overflowX="auto"))}function getTextWithNewlinesFromRange(e){const t=e.cloneContents();let n="";return function e(t){if(t.nodeType===Node.TEXT_NODE)n+=t.textContent;else if(t.nodeType===Node.ELEMENT_NODE||t.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const o=t.tagName?.toLowerCase();["div","p","li","tr","br"].includes(o)&&(n+="\n");for(const n of t.childNodes)e(n);["div","p","li","tr"].includes(o)&&(n+="\n")}}(t),n.replace(/\n{3,}/g,"\n\n").trim()}function reflow(e){if(!savedEditorRange)return void setStatus("No selection saved.");const t=savedEditorRange.cloneRange();let n=getTextWithNewlinesFromRange(t);if(!n.trim())return void setStatus("Selection is empty.");n=n.replaceAll(/\s*\r?\n\s*/g," ");let o="",r=0;for(let t=0;t<n.length;t++){const s=n[t];(" "===s||"\t"===s)&&r>e?(o+="\n",r=0):(o+=s,r++)}t.deleteContents(),t.insertNode(document.createTextNode(o))}function smartReturnPress(){const e=document.getElementById("editor"),t=window.getSelection(),n=savedEditorRange;if(!n||!e.contains(n.commonAncestorContainer))return;const o=n.cloneRange();o.setStart(e,0);const r=getTextWithNewlinesFromRange(o),s=r.lastIndexOf("\n"),l=r.slice(s+1),a=l.trim(),i=a.charAt(a.length-1);let c="";const d=(a.match(/\(/g)||[]).length,u=(a.match(/\)/g)||[]).length;("{"===i||":"===i||d>u)&&(c="    ");const g=l.match(/^\s*/),m=g?g[0]:"",f=`\n${c}${m}`,p=n.cloneRange();p.setEndAfter(e.lastChild);if(p.toString().trimStart().startsWith("}")){const e=`\n${m}`;n.deleteContents();const o=document.createTextNode(f+e);n.insertNode(o);const r=c.length+m.length+1,s=document.createRange();s.setStart(o,r),s.setEnd(o,r),t.removeAllRanges(),t.addRange(s)}else{n.deleteContents();const e=document.createTextNode(f);n.insertNode(e);const o=f.length,r=document.createRange();r.setStart(e,o),r.setEnd(e,o),t.removeAllRanges(),t.addRange(r)}e.scrollTop=e.scrollHeight}function uc(){transformSelectedText((e=>e.toUpperCase()))}function lc(){transformSelectedText((e=>e.toLowerCase()))}function tc(){transformSelectedText((e=>e.replace(/\w\S*/g,(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()))))}function splitWords(e){return e.replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/[_\-]+/g," ").toLowerCase().trim().split(/\s+/)}function toCamelCase(e){const t=splitWords(e);return t[0]+t.slice(1).map(capitalize).join("")}function toSnakeCase(e){return splitWords(e).join("_")}function toKebabCase(e){return splitWords(e).join("-")}function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function camel(){transformSelectedText((e=>toCamelCase(e)))}function snake(){transformSelectedText((e=>toSnakeCase(e)))}function kebab(){transformSelectedText((e=>toKebabCase(e)))}function transformSelectedText(e){if(!savedEditorRange)return void setStatus("No selection saved.");const t=savedEditorRange.cloneRange(),n=getTextWithNewlinesFromRange(t);if(!n)return void setStatus("Selection is empty.");const o=e(n);t.deleteContents();const r=document.createTextNode(o);t.insertNode(r)}function wc(){if(!savedEditorRange)return setStatus("No selection saved."),0;const e=savedEditorRange.toString().trim();if(!e)return setStatus("No text selected."),0;const t=e.split(/\s+/).length;return setStatus("Word count: "+t),t}function setStatus(e){const t=document.getElementById("statusText");t&&(t.value=e+"\n"+t.value)}function showText(e,t){dec=Base64.decode(e),popup(dec,t)}function popup(e,t){var n=window.open("",t,",resizable=false,height=800,width=1000,titlebar=0,toolbar=0"),o=n.document;o.write("<html><head>"),o.write('<style type="text/css">'),o.write("body { background-color: white ;  color: black; }"),o.write("\ntextarea {width: 100%;  height: 100%; }"),o.write("</style></head>"),o.write("<body><textarea id=myarea>"),o.write("</textarea></body></html>"),n.focus(),o.getElementById("myarea").value=e,o.close()}function showTextPopup(e,t,n=""){textPopupCallback=e;const o=document.getElementById("textPopup"),r=document.getElementById("popupTextarea");document.getElementById("popupTextAreaHeading").innerText=t,r.value=n,o.style.display="block",r.focus()}function submitTextPopup(){const e=document.getElementById("popupTextarea").value;closeTextPopup(),textPopupCallback&&textPopupCallback(e)}function closeTextPopup(){document.getElementById("textPopup").style.display="none"}document.getElementById("fileLoader").addEventListener("change",(function(e){const t=e.target.files[0];if(!t)return void alert("No file selected.");currentFileName=t.name;const n=new FileReader;n.onload=function(e){const n=e.target.result,o=document.getElementById("editor");if("text/html"===t.type||t.name.endsWith(".html")){const e=(new DOMParser).parseFromString(n,"text/html").getElementById("editor");if(e)return o.innerHTML=e.innerHTML,void setStatus("Loaded editor content from HTML file.")}const r=document.createElement("div");r.innerHTML=escapeTextWithLineBreaks(n),o.innerHTML="",o.appendChild(r),setStatus("Loaded plain text file content.")},n.onerror=function(e){alert("Error reading file!")},n.readAsText(t)})),window.addEventListener("DOMContentLoaded",(()=>{toggleLineWrap(!0)}));var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,o,r,s,l,a,i="",c=0;for(e=Base64._utf8_encode(e);c<e.length;)r=(t=e.charCodeAt(c++))>>2,s=(3&t)<<4|(n=e.charCodeAt(c++))>>4,l=(15&n)<<2|(o=e.charCodeAt(c++))>>6,a=63&o,isNaN(n)?l=a=64:isNaN(o)&&(a=64),i=i+this._keyStr.charAt(r)+this._keyStr.charAt(s)+this._keyStr.charAt(l)+this._keyStr.charAt(a);return i},decode:function(e){var t,n,o,r,s,l,a="",i=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<e.length;)t=this._keyStr.indexOf(e.charAt(i++))<<2|(r=this._keyStr.indexOf(e.charAt(i++)))>>4,n=(15&r)<<4|(s=this._keyStr.indexOf(e.charAt(i++)))>>2,o=(3&s)<<6|(l=this._keyStr.indexOf(e.charAt(i++))),a+=String.fromCharCode(t),64!=s&&(a+=String.fromCharCode(n)),64!=l&&(a+=String.fromCharCode(o));return a=Base64._utf8_decode(a)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):o>127&&o<2048?(t+=String.fromCharCode(o>>6|192),t+=String.fromCharCode(63&o|128)):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128),t+=String.fromCharCode(63&o|128))}return t},_utf8_decode:function(e){for(var t="",n=0,o=c1=c2=0;n<e.length;)(o=e.charCodeAt(n))<128?(t+=String.fromCharCode(o),n++):o>191&&o<224?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&o)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),n+=3);return t}};function noteButtonClickHandler(e){e.preventDefault(),showNoteEditPopup(e)}function createMessageButton(e,t){const n=document.getElementById("editor"),o=savedEditorRange;if(!o||!n.contains(o.commonAncestorContainer))return void alert("No valid insertion point found. Please place the cursor inside the editor before opening the popup.");const r=document.createElement("button");r.textContent=e,r.setAttribute("data-message",t),r.setAttribute("onclick","noteButtonClickHandler(event)"),r.setAttribute("class","note-button"),r.onclick=noteButtonClickHandler,o.insertNode(r),savedEditorRange=null}function showNoteInputPopup(){showTextPopup((function(e){createMessageButton("",Base64.encode(e))}),"Create Note:")}function showNoteEditPopup(e){showTextPopup((function(t){var n=Base64.encode(t);e.target.setAttribute("data-message",n)}),"Edit Note:",Base64.decode(e.target.getAttribute("data-message")))}function saveEditorRange(){const e=document.getElementById("editor"),t=window.getSelection();if(t.rangeCount>0){const n=t.getRangeAt(0);e.contains(n.commonAncestorContainer)&&(savedEditorRange=n.cloneRange())}}const editor=document.getElementById("editor");function insertHtmlAtSavedRange(e){if(!savedEditorRange)return void setStatus("No saved cursor position to insert HTML.");const t=document.createRange().createContextualFragment(e),n=savedEditorRange.cloneRange();n.deleteContents(),n.insertNode(t),setStatus("HTML inserted at cursor.")}function showHtmlInsertPrompt(){showTextPopup(insertHtmlAtSavedRange,"")}function matchAndHighlightBrackets(){const e=document.getElementById("editor"),t=(window.getSelection(),savedEditorRange);if(null==t)return;const n=t.startContainer,o=t.startOffset,r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let s,l="",a=[];for(;s=r.nextNode();){const e=l.length,t=s.textContent;l+=t,a.push({node:s,start:e,end:e+t.length})}let i=-1;for(const e of a)if(e.node===n){i=e.start+o;break}if(-1===i)return;const c=new Set(["(","[","{"]),d=(new Set([")","]","}"]),l[i]||l[i-1]),u=c.has(d),g={"(":")","[":"]","{":"}",")":"(","]":"[","}":"{"}[d],m=i;if(!g)return;let f=0,p=-1;if(u)for(let e=m+1;e<l.length;e++){const t=l[e];if(t===d)f++;else if(t===g){if(0===f){p=e;break}f--}}else for(let e=m-1;e>=0;e--){const t=l[e];if(t===d)f++;else if(t===g){if(0===f){p=e;break}f--}}if(-1===p)return;const h=randomHilightColor();m>p?(applyHighlightToMatch(m,a,h),applyHighlightToMatch(p,a,h)):(applyHighlightToMatch(p,a,h),applyHighlightToMatch(m,a,h))}function findNodeAtOffset(e,t){for(const{node:n,start:o,end:r}of t)if(e>=o&&e<r)return{node:n,offset:e-o};return null}function applyHighlightToMatch(e,t,n){const o=findNodeAtOffset(e,t);if(!o)return;const r=document.createRange();r.setStart(o.node,o.offset),r.setEnd(o.node,o.offset+1);const s=document.createElement("span");s.style.backgroundColor=n,s.className="highlight",r.surroundContents(s)}function indentSelectedLines(e=!0){const t=document.getElementById("editor"),n=savedEditorRange;if(!n||!t.contains(n.commonAncestorContainer))return;if(n.collapsed)return void tabPressedNoSelection(e,n);const o=getTextWithNewlinesFromRange(n);if(!o)return;event.preventDefault();const r=o.split(/\r?\n/).map((t=>e?"    "+t:t.startsWith("    ")?t.slice(4):t.startsWith("   ")?t.slice(3):t.startsWith("  ")?t.slice(2):t.startsWith(" ")||t.startsWith("\t")?t.slice(1):t)).join("\n");n.deleteContents();const s=document.createTextNode(r);n.insertNode(s),setStatus(e?"Indented selected lines.":"Unindented selected lines."),window.getSelection().removeAllRanges()}function getRangeBeforeCursor(e,t=4){const n=document.createRange();let o=t,{startContainer:r,startOffset:s}=e;for(n.setStart(r,s),n.setEnd(r,s);o>0;){if(r.nodeType===Node.TEXT_NODE){const e=Math.min(s,o);if(e>0&&(s-=e,n.setStart(r,s),o-=e,0===o))break}const e=getPreviousTextNode(r);if(!e)break;r=e,s=e.textContent.length}return n}function getPreviousTextNode(e){for(;e;){if(e.previousSibling)for(e=e.previousSibling;e&&e.lastChild;)e=e.lastChild;else e=e.parentNode;if(e&&e.nodeType===Node.TEXT_NODE)return e}return null}function tabPressedNoSelection(e,t){if(e){const e=document.createTextNode("    ");t.insertNode(e),t.setStartAfter(e),t.collapse(!0);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else{var o=getRangeBeforeCursor(t,4);if("    "===o.toString()){o.deleteContents();(o.startContainer.nodeType===Node.ELEMENT_NODE?o.startContainer:o.startContainer.parentNode).normalize()}}}function cursorsAtStart(){const e=savedEditorRange;if(!e||e.collapsed)return;const t=document.getElementById("editor"),n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1),o=new Map;for(;n.nextNode();){const t=n.currentNode;if(!e.intersectsNode(t))continue;if(!t.textContent.trim())continue;const r=document.createRange();r.selectNodeContents(t);Array.from(r.getClientRects()).forEach((e=>{const n=Math.round(e.top),r=e.left;(!o.has(n)||r<o.get(n).left)&&o.set(n,{node:t,offset:0,left:r})}))}const r=[];for(const{node:e,offset:t}of o.values()){const n=document.createRange();n.setStart(e,t),n.collapse(!0),r.push({range:n,span:null})}cursors=r,updateCursorVisualPositions()}function getClientRectsSafe(e){const t=document.createRange();return t.selectNodeContents(e),Array.from(t.getClientRects())}function cursorsAtEnd(){const e=savedEditorRange;if(!e||e.collapsed)return;const t=document.getElementById("editor"),n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1),o=new Map;for(;n.nextNode();){const t=n.currentNode;if(!e.intersectsNode(t))continue;const r=getClientRectsSafe(t),s=t.textContent.length;r.forEach((e=>{const n=Math.round(e.top),r=o.get(n);(!r||e.right>r.right)&&o.set(n,{node:t,offset:s,right:e.right})}))}const r=[];for(const{node:e,offset:t}of o.values()){const n=document.createRange();n.setStart(e,t),n.collapse(!0),r.push({range:n})}cursors=r,updateCursorVisualPositions()}editor.addEventListener("keydown",saveEditorRange),editor.addEventListener("click",saveEditorRange),editor.addEventListener("click",insertCursorOnMouseDown),editor.addEventListener("mouseup",(function(){saveEditorRange(),null!=currentFixedHighlighter&&applyHighlightAndFont(currentFixedHighlighter,!0,currentFixedHighlighter)})),editor.addEventListener("keydown",saveEditorRange),document.addEventListener("keydown",(function(e){if(e.ctrlKey&&!e.altKey){if("m"===e.key.toLowerCase())e.preventDefault(),showNoteInputPopup();else if("l"===e.key.toLowerCase())e.preventDefault(),startRecording();else if("q"===e.key)e.preventDefault(),showJsEvalPopup();else if("b"===e.key)e.preventDefault(),toolbarsVisible?hideTools():showTools();else if("i"===e.key.toLowerCase())e.preventDefault(),showHtmlInsertPrompt();else if("h"===e.key.toLowerCase())e.preventDefault(),help();else if(/^[1-7]$/.test(e.key)){e.preventDefault();var t=document.getElementById("searchBox"+e.key);const n=window.getSelection();if(0===n.rangeCount||n.isCollapsed){const t=parseInt(e.key);for(let e=1;e<=7;e++){const n=document.getElementById(`searchResults${e}`);n&&(n.style.display=e===t?"block":"none")}return}t.value=n.toString(),t.focus()}}else if(ctrlAltEquivalent(e))if("m"===e.key.toLowerCase()?(e.preventDefault(),matchAndHighlightBrackets()):"p"===e.key.toLowerCase()?(e.preventDefault(),showImageScalingPopup()):"s"===e.key.toLowerCase()?(e.preventDefault(),save()):"z"===e.key.toLowerCase()?(e.preventDefault(),undo()):"y"===e.key.toLowerCase()&&(e.preventDefault(),redo()),"c"===e.key.toLowerCase())e.preventDefault(),clearAllHighlight();else if("r"===e.key.toLowerCase())e.preventDefault(),speakSelection();else if("V"===e.key)e.preventDefault(),cursors&&0!==cursors.length?pasteHtmlAtCursors():pasteSegmentsAcrossLines();else if("v"===e.key)e.preventDefault(),cursors&&0!==cursors.length?pasteHtmlAtCursors():pasteSegmentsAtLineStarts();else if("k"===e.key)e.preventDefault(),keeplines();else if("d"===e.key)e.preventDefault(),dellines();else if("K"===e.key)e.preventDefault(),keeplinesWithHighlights();else if("D"===e.key)e.preventDefault(),dellinesWithHighlights();else if("q"===e.key)e.preventDefault(),insertDownloadLinkAtSavedRange();else if("s"===e.key){e.preventDefault();const t=document.getElementById("editor").outerHTML,n=generateFileName(),o=new Blob([t],{type:"text/html"}),r=document.createElement("a");r.href=URL.createObjectURL(o),r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),setStatus(`File '${n}' saved.`)}else"n"===e.key&&(e.preventDefault(),toggleLineNumbers());else if(0==cursors.length&&"Enter"===e.key&&"editor"===e.target.id){""!=document.getElementById("editor").innerHTML&&(e.preventDefault(),smartReturnPress())}else if(0!=cursors.length||"}"!==e.key&&"{"!==e.key){if(0==cursors.length&&"Tab"===e.key)e.preventDefault(),indentSelectedLines(!e.shiftKey);else if("Escape"===e.key)e.preventDefault(),showJsEvalPopup();else if(cursors.length>0&&!e.ctrlKey&&!e.metaKey){if(!e.target.closest("#editor"))return;e.preventDefault(),"Delete"===e.key?(e.target.closest("#editor"),deleteAtCursors()):"Backspace"===e.key?backspaceAtCursors():1==e.key.length?insertTextAtCursors(e.key):"Enter"==e.key?insertTextAtCursors("\n"):"Tab"==e.key?(insertTextAtCursors(" "),updateCursorVisualPositions(),insertTextAtCursors(" "),updateCursorVisualPositions(),insertTextAtCursors(" "),updateCursorVisualPositions(),insertTextAtCursors(" ")):"ArrowLeft"===e.key?moveCursors("left"):"ArrowRight"===e.key&&moveCursors("right"),updateCursorVisualPositions()}}else{if(!e.target.closest("#editor"))return;e.preventDefault(),handleBraceKey(e)}}));let cursors=[];function clearCursorSpans(){document.querySelectorAll(".cursor").forEach((e=>{e.remove()}))}function getNextTextNode(e){for(;e;){if(e.nextSibling)for(e=e.nextSibling;e&&e.firstChild;)e=e.firstChild;else e=e.parentNode;if(!e||e.nodeType===Node.TEXT_NODE)return e}return null}function getNextTextNodeDeep(e){const t=document.getElementById("editor");for(;e;){if(e.firstChild)e=e.firstChild;else{for(;e&&!e.nextSibling;)if(e=e.parentNode,!t.contains(e))return null;e&&(e=e.nextSibling)}if(e&&e.nodeType===Node.TEXT_NODE&&e.textContent.length>0&&t.contains(e))return e}return null}function getPreviousTextNodeDeep(e){const t=document.getElementById("editor");for(;e;){if(e.previousSibling)for(e=e.previousSibling;e&&e.lastChild;)e=e.lastChild;else if(e=e.parentNode,!t.contains(e))return null;if(e&&e.nodeType===Node.TEXT_NODE&&e.textContent.length>0&&t.contains(e))return e}return null}function backspaceAtCursors(){const e=document.getElementById("editor"),t=[];clearCursorSpans();[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range))).forEach((n=>{const o=n.range;if(!o.collapsed)return;let r=o.startContainer,s=o.startOffset;if(!e.contains(r))return;if(r.nodeType===Node.ELEMENT_NODE){if(r.childNodes[s-1]?.nodeType!==Node.TEXT_NODE)return;r=r.childNodes[s-1],s=r.textContent.length}if(r.nodeType===Node.TEXT_NODE&&s>0){const e=r.textContent;r.textContent=e.slice(0,s-1)+e.slice(s);const n=document.createRange();return n.setStart(r,s-1),n.collapse(!0),void t.push({range:n,span:null})}const l=getPreviousTextNodeDeep(r);if(l&&l.textContent.length>0){const e=l.textContent.slice(0,-1);l.textContent=e;const n=document.createRange();return n.setStart(l,e.length),n.collapse(!0),void t.push({range:n,span:null})}const a=document.createRange();a.setStart(r,s),a.collapse(!0),t.push({range:a,span:null})})),cursors=t}function deleteAtCursors(){const e=document.getElementById("editor"),t=[];clearCursorSpans();[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range))).forEach((n=>{const o=n.range;if(!o.collapsed)return;let r=o.startContainer,s=o.startOffset;if(!e.contains(r))return;if(r.nodeType===Node.ELEMENT_NODE){if(r.childNodes[s]?.nodeType!==Node.TEXT_NODE)return;r=r.childNodes[s],s=0}if(r.nodeType===Node.TEXT_NODE){const e=r.textContent;if(s<e.length){r.textContent=e.slice(0,s)+e.slice(s+1);const n=document.createRange();return n.setStart(r,s),n.collapse(!0),void t.push({range:n,span:null})}}let l=getNextTextNodeDeep(r);if(l&&l.textContent.length>0){l.textContent=l.textContent.slice(1);const e=document.createRange();return e.setStart(l,0),e.collapse(!0),void t.push({range:e,span:null})}const a=document.createRange();a.setStart(r,s),a.collapse(!0),t.push({range:a,span:null})})),cursors=t}function updateCursorVisualPositions(){const e=document.getElementById("editor");e.normalize(),cursors.forEach((({span:e})=>{e&&e.parentNode&&e.remove()})),cursors.forEach((t=>{const n=t.range,o=n.startContainer;if(!e.contains(o))return void console.warn("Cursor container not in editor:",o);if(o.nodeType===Node.TEXT_NODE){const e=o.textContent.length;n.startOffset>e&&(n.setStart(o,e),n.collapse(!0))}const r=document.createElement("span");r.className="cursor";try{n.insertNode(r),n.setStartAfter(r),n.collapse(!0),t.span=r}catch(e){console.warn("Failed to insert cursor span:",e)}}))}function showImageScalingPopup(){const e=document.getElementById("scaleImagePopup"),t=document.getElementById("scaleImageInput");e.style.display="block",t.value="",t.focus()}function scaleImagePressEnter(e){"Enter"===e.key&&(e.preventDefault(),submitImageScaling())}function closeScaleImagePopup(){document.getElementById("scaleImagePopup").style.display="none"}function submitImageScaling(){const e=document.getElementById("scaleImageInput").value.trim();closeScaleImagePopup();const t=parseFloat(e);isNaN(t)||t<=0?alert("Please enter a valid positive number."):applyImageScaling(t)}function applyImageScaling(e){const t=document.getElementById("editor");let n=[];if(savedEditorRange&&t.contains(savedEditorRange.commonAncestorContainer)){if(n=[...savedEditorRange.cloneContents().querySelectorAll("img")],n.length>0){const t=savedEditorRange.cloneContents();t.querySelectorAll("img").forEach((t=>{const n=t.width*(e/100);t.width=n,t.removeAttribute("height")}));const o=savedEditorRange.cloneRange();return o.deleteContents(),o.insertNode(t),savedEditorRange=null,window.getSelection().removeAllRanges(),void setStatus(`Scaled ${n.length} image(s) to ${e}%.`)}}if(savedEditorRange&&t.contains(savedEditorRange.commonAncestorContainer)){let n=savedEditorRange.startContainer,o=null,r=1/0;t.querySelectorAll("img").forEach((e=>{const t=Math.abs(e.compareDocumentPosition(n));t<r&&(o=e,r=t)})),o?(o.width=o.width*(e/100),o.removeAttribute("height"),setStatus(`Scaled nearest image to ${e}%.`)):alert("No image found near the cursor.")}}function handleBraceKey(e){const t=document.getElementById("editor"),n=window.getSelection();if(!n.rangeCount)return;const o=n.getRangeAt(0),r=o.startContainer,s=o.startOffset;if(!t.contains(r)||r.nodeType!==Node.TEXT_NODE)return;const l=r.textContent.lastIndexOf("\n",s-1)+1,a=r.textContent.indexOf("\n",s),i=-1===a?r.textContent.length:a,c=r.textContent.slice(l,i);if("}"===e.key){if(/^\s+$/.test(c)){let t=c;for(let e=0;e<4&&t.startsWith(" ");e++)t=t.slice(1);const o=r.textContent.slice(0,l),s=o+t+r.textContent.slice(i);r.textContent=s;const a=o.length+t.length,d=document.createRange();d.setStart(r,a),d.setEnd(r,a),n.removeAllRanges(),n.addRange(d),e.preventDefault()}}else if("{"===e.key){e.preventDefault();const t=r.textContent.slice(0,s),o=r.textContent.slice(s);r.textContent=t+"{}"+o;const l=document.createRange();l.setStart(r,s+1),l.setEnd(r,s+1),n.removeAllRanges(),n.addRange(l)}}const jsHistory=[];let jsHistoryIndex=-1,mediaRecorder;function showJsEvalPopup(){const popup=document.getElementById("jsEvalPopup"),input=document.getElementById("jsEvalInput");popup.style.display="block",input.value="",input.focus(),jsHistoryIndex=jsHistory.length,input.onkeydown=function(event){if("y"===event.key){var toEval=input.value.trim();if(/^[0-9]*y$/.test(toEval)){toEval="yy("+toEval.slice(0,-1)+")";const result=eval(toEval);return input.value="",void(popup.style.display="none")}}else if("d"==event.key){var toEval=input.value.trim();if(/^[0-9]*d$/.test(toEval)){toEval="dd("+toEval.slice(0,-1)+")";const result=eval(toEval);return input.value="",void(popup.style.display="none")}}if("Enter"===event.key){event.preventDefault();const code=input.value.trim();code&&(jsHistory.push(code),jsHistoryIndex=jsHistory.length);let toEval=code;/[()=]/.test(toEval)||(toEval+="()");try{const result=eval(toEval);setStatus("JS Eval Result: "+result)}catch(e){setStatus("Error: "+e.message),console.error("[JS Eval Error]",e)}popup.style.display="none"}else"ArrowUp"===event.key?(event.preventDefault(),jsHistoryIndex>0&&(jsHistoryIndex--,input.value=jsHistory[jsHistoryIndex])):"ArrowDown"===event.key?(event.preventDefault(),jsHistoryIndex<jsHistory.length-1?(jsHistoryIndex++,input.value=jsHistory[jsHistoryIndex]):(jsHistoryIndex=jsHistory.length,input.value="")):"Escape"===event.key&&(popup.style.display="none",event.preventDefault())}}let audioChunks=[];function startRecording(){navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{mediaRecorder=new MediaRecorder(e),mediaRecorder.ondataavailable=e=>{e.data.size>0&&audioChunks.push(e.data)},mediaRecorder.onstop=()=>{const e=new Blob(audioChunks,{type:"audio/webm"}),t=new FileReader;t.onloadend=()=>{const e=t.result,n=document.createElement("audio");n.controls=!0,n.src=e,n.setAttribute("style","width: 24px; height: 15px; background: #aafba2; background-color: #aafba2; foreground: #aafba2; "),insertNodeAtCursor(n),audioChunks=[],hideStopRecordingButton()},t.readAsDataURL(e)},mediaRecorder.start(),showStopRecordingButton()})).catch((e=>{alert("Microphone access denied or unavailable."),console.error(e)}))}function showStopRecordingButton(){document.getElementById("stopRecordingPopup").style.display="block"}function hideStopRecordingButton(){document.getElementById("stopRecordingPopup").style.display="none"}function stopRecording(){mediaRecorder&&"inactive"!==mediaRecorder.state&&mediaRecorder.stop()}function insertNodeAtCursor(e){const t=document.getElementById("editor"),n=savedEditorRange;n&&t.contains(n.commonAncestorContainer)?(n.collapse(!1),n.insertNode(e)):alert("No valid insertion point found. Please place the cursor inside the editor before opening the popup.")}document.getElementById("editorBgColor").addEventListener("input",(function(e){document.getElementById("editor").style.backgroundColor=e.target.value}));let lastTargetId=null;function generateRandomId(e=12){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let n="";for(let o=0;o<e;o++)n+=t.charAt(Math.floor(Math.random()*t.length));return"edz"+n}function target(e=null){if(!savedEditorRange)return void setStatus("No selection saved to mark as target.");const t=savedEditorRange.cloneRange(),n=e||generateRandomId(),o=document.createElement("span");o.id=n,o.textContent=t.toString(),t.deleteContents(),t.insertNode(o),lastTargetId=n,setStatus("Target set with id: "+n)}function link(e=null){if(!savedEditorRange)return void setStatus("No selection saved to create link.");const t=savedEditorRange.cloneRange(),n=e||lastTargetId;if(!n)return void setStatus("No target ID available to link to.");const o=document.createElement("a");o.href="#"+n,o.textContent=t.toString(),o.setAttribute("onclick","selectText('"+n+"')"),t.deleteContents(),t.insertNode(o),setStatus("Link created to target id: "+n)}function selectText(e){if(document.selection){var t=document.body.createTextRange();element=document.getElementById(e),null!=element&&(t.moveToElementText(element),t.select(),element.scrollIntoView(),setTimeout((function(){element.scrollIntoView({behavior:"smooth"})}),1e3))}else if(window.getSelection){t=document.createRange();element=document.getElementById(e),null!=element&&(t.selectNode(element),window.getSelection().removeAllRanges(),window.getSelection().addRange(t),element.scrollIntoView(),setTimeout((function(){element.scrollIntoView({behavior:"smooth"})}),1e3))}}var toolbarsVisible=!0;function hideTools(){document.querySelectorAll(".toolbars").forEach((e=>e.style.display="none")),toolbarsVisible=!1}function showTools(){document.querySelectorAll(".toolbars").forEach((e=>e.style.display="block")),toolbarsVisible=!0}function xlink(e=null){function t(e){if(!e)return void setStatus("No URL provided.");const t=savedEditorRange.cloneRange(),n=document.createElement("a");n.href=e,n.target="_blank",n.textContent=t.toString(),t.deleteContents(),t.insertNode(n),setStatus("External link created to: "+e)}savedEditorRange?e?t(e):showTextPopup(t,"Enter URL:","https://"):setStatus("No selection saved to create external link.")}function copyHandler(e){e.preventDefault(),setStatus("Copying to clipboard");const t=window.getSelection();if(t.isCollapsed)return;const n=t.getRangeAt(0),o=document.createElement("div");o.appendChild(n.cloneContents()),o.querySelectorAll(".note-button").forEach((e=>{e.setAttribute("data-message",e.dataset.message)})),o.querySelectorAll("a[onclick]").forEach((e=>{const t=e.getAttribute("onclick")?.match(/selectText\(['"](.+?)['"]\)/);t&&e.setAttribute("data-select-id",t[1]),e.removeAttribute("onclick")}));const r=postProcessForEmail(o.innerHTML),s=extractTextWithNewlines(o);e.clipboardData.setData("text/html",r),e.clipboardData.setData("text/plain",s)}function extractTextWithNewlines(e){let t="";return function e(n){if(n.nodeType===Node.TEXT_NODE)t+=n.nodeValue;else if(n.nodeType===Node.ELEMENT_NODE){const o=n.tagName.toLowerCase();["div","p","br","li","tr"].includes(o)&&(t.endsWith("\n")||(t+="\n"));for(const t of n.childNodes)e(t);["div","p","li","tr"].includes(o)&&(t.endsWith("\n")||(t+="\n"))}}(e),t.replace(/\n{3,}/g,"\n\n").replace(/[ \t]+\n/g,"\n").trim()}function postProcessForEmail(e){const t=e.split(/(<[A-Za-z][^>]*>)|(\n)/i);let n="";for(let e=0;e<t.length;e++){const o=t[e];void 0===o||(/(^<br\s*\/?>$)|(^\n$)/i.test(o)?n+="<br>":n+=o.replace(/^\s+/,(e=>e.replace(/ /g,"&nbsp;").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"))))}return n}function copyEditorToClipboard(){const e=document.getElementById("editor"),t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();n.removeAllRanges(),n.addRange(t),document.execCommand("copy")}function setDefaultFont(){const e=document.getElementById("fontChooser").value,t=document.getElementById("sizeChooser").value,n=document.getElementById("editor");if("No Selection"!==e&&(n.style.fontFamily=e),"0"!==t)switch(t){case"1":n.style.fontSize="x-small";break;case"3":default:n.style.fontSize="medium";break;case"5":n.style.fontSize="x-large";break;case"7":n.style.fontSize="xx-large"}}document.getElementById("editor").addEventListener("copy",copyHandler),document.getElementById("editor").addEventListener("paste",(function(e){setTimeout((()=>{const e=document.getElementById("editor");e.querySelectorAll("button.note-button").forEach((e=>{e.dataset.message&&(e.removeAttribute("onclick"),e.setAttribute("onclick","noteButtonClickHandler(event)"))})),e.querySelectorAll("a[data-select-id]").forEach((e=>{const t=e.getAttribute("data-select-id");t&&e.setAttribute("onclick","selectText('"+t+"')")}))}),100)}));let undoStack=[],redoStack=[];function save(){const e=document.getElementById("editor").innerHTML,t=savedEditorRange?savedEditorRange.cloneRange():null;undoStack.push({html:e,selection:t}),redoStack=[],setStatus("SAVE undoStackLength="+undoStack.length+" redoStackLength="+redoStack.length)}function undo(){if(setStatus("UNDO ength="+undoStack.length+" redoStackLength="+redoStack.length),0===undoStack.length)return;const e=document.getElementById("editor"),t={html:e.innerHTML,selection:savedEditorRange?savedEditorRange.cloneRange():null};redoStack.push(t);const n=undoStack.pop();if(e.innerHTML=n.html,n.selection){const e=window.getSelection();e.removeAllRanges(),e.addRange(n.selection),savedEditorRange=n.selection.cloneRange()}}function redo(){if(setStatus("REDO : undoStackLength="+undoStack.length+" redoStackLength="+redoStack.length),0===redoStack.length)return;const e=document.getElementById("editor"),t={html:e.innerHTML,selection:savedEditorRange?savedEditorRange.cloneRange():null};undoStack.push(t);const n=redoStack.pop();if(e.innerHTML=n.html,n.selection){const e=window.getSelection();e.removeAllRanges(),e.addRange(n.selection),savedEditorRange=n.selection.cloneRange()}}function darken(){dark=!0,function e(t){if(t.nodeType===Node.ELEMENT_NODE){const e=t.tagName?.toLowerCase();if(["input","textarea","button","select"].includes(e)){const e=window.getComputedStyle(t),n=e.backgroundColor||"rgb(255,255,255)",o=e.color||"rgb(17,17,17)";t.style.backgroundColor=invertCSSColor(n),t.style.color=invertCSSColor(o),t.style.borderColor=invertCSSColor(e.borderColor||"rgb(17,17,17)"),t.style.caretColor=invertCSSColor(o)}else t.style.backgroundColor="#111111",t.style.color="#ffffff"}for(const n of t.childNodes)e(n)}(document.body),invertHighlightClassColors(),document.getElementById("editorBgColor").value="#111111",document.getElementById("editor").style.backgroundColor="#111111",document.getElementById("hlButton7").style.backgroundColor="#000000",document.getElementById("editor").style.backgroundColor="#111111",document.getElementById("colorChooser").value="#ffffff";const e=document.getElementById("fileLoader");e.style.backgroundColor="#111111",e.style.color="#ffffff",e.style.border="1px solid #ffffff",setStatus("Dark mode applied")}function invertHighlightClassColors(){for(const e of document.styleSheets)try{for(const t of e.cssRules)if(t.selectorText.startsWith(".highlight")){const e=invertCSSColor(t.style.backgroundColor);t.style.backgroundColor=e}}catch(e){continue}}function invertCSSColor(e){const t=e.match(/rgba?\((\d+), (\d+), (\d+)/);if(!t)return e;return`rgb(${255-parseInt(t[1])}, ${255-parseInt(t[2])}, ${255-parseInt(t[3])})`}function help(){document.getElementById("helpPopup").style.display="block"}function closeHelp(){document.getElementById("helpPopup").style.display="none"}let awsAccessKey="",awsSecretAccessKey="",awsRegion="",awsBucketName="",awsFolderName="";function showAWSConfigPopup(){document.getElementById("awsAccessKey").value=awsAccessKey||"",document.getElementById("awsSecretKey").value=awsSecretAccessKey||"",document.getElementById("awsRegion").value=awsRegion||"",document.getElementById("awsBucket").value=awsBucketName||"",document.getElementById("awsFolder").value=awsFolderName||"",document.getElementById("awsConfigPopup").style.display="block"}function saveAWSConfig(){awsAccessKey=document.getElementById("awsAccessKey").value.trim(),awsSecretAccessKey=document.getElementById("awsSecretKey").value.trim(),awsRegion=document.getElementById("awsRegion").value.trim(),awsBucketName=document.getElementById("awsBucket").value.trim(),awsFolderName=document.getElementById("awsFolder").value.trim(),document.getElementById("awsConfigPopup").style.display="none",setStatus("AWS config stored.")}function saveToS3(e){if(!(awsAccessKey&&awsSecretAccessKey&&awsRegion&&awsBucketName&&awsFolderName))return void alert("AWS S3 configuration is incomplete.");AWS.config.update({accessKeyId:awsAccessKey,secretAccessKey:awsSecretAccessKey,region:awsRegion});const t=new AWS.S3({region:awsRegion,endpoint:`https://s3.${awsRegion}.amazonaws.com`,s3ForcePathStyle:!1}),n=document.getElementById("editor").innerHTML,o=awsFolderName.replace(/\/?$/,"/")+e,r={Bucket:awsBucketName,Key:o,Body:n,ContentType:"text/html"};console.log("Saving to:",r.Key),t.putObject(r,(function(e,t){e?(console.error("S3 Save Error:",e),setStatus("❌ Save to S3 failed: "+e.message)):(console.log("✅ Save successful:",t),setStatus("✅ Editor content saved to S3."))}))}function loadFromS3(e){if(!(awsAccessKey&&awsSecretAccessKey&&awsRegion&&awsBucketName&&awsFolderName))return void alert("AWS S3 configuration is incomplete.");AWS.config.update({accessKeyId:awsAccessKey,secretAccessKey:awsSecretAccessKey,region:awsRegion});const t=new AWS.S3({region:awsRegion,endpoint:`https://s3.${awsRegion}.amazonaws.com`,s3ForcePathStyle:!1}),n=awsFolderName.replace(/\/?$/,"/")+e,o={Bucket:awsBucketName,Key:n};console.log("Loading from:",o.Key),t.getObject(o,(function(e,t){if(e)console.error("S3 Load Error:",e),setStatus("❌ Load from S3 failed: "+e.message);else{const e=t.Body.toString("utf-8");document.getElementById("editor").innerHTML=e,setStatus("✅ Editor content loaded from S3.")}}))}function promptAndSaveToS3(){const e=prompt("Enter filename to save:","editor-content");e&&""!==e.trim()?saveToS3(e.trim()):setStatus("⚠️ Save cancelled or invalid filename.")}function promptAndLoadFromS3(){const e=prompt("Enter filename to load:","editor-content");e&&""!==e.trim()?loadFromS3(e.trim()):setStatus("⚠️ Load cancelled or invalid filename.")}function removeSpansWithClass(e){const t=document.getElementById("editor");if(!t)return void console.warn("Editor element not found.");const n=t.querySelectorAll(`span.${e}`);n.forEach((e=>{const t=e.parentNode;for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e)})),setStatus(`Removed ${n.length} span(s) with class "${e}".`)}function removeSpanContentsForClass(e){const t=document.getElementById("editor");if(!t)return void console.warn("Editor element not found.");const n=t.querySelectorAll(`span.${e}`);let o=0;n.forEach((e=>{e.remove(),o++})),setStatus(`❌ Removed ${o} span(s) with class "${e}" and their contents.`)}function removeEmptyLinesFromEditor(){const e=document.getElementById("editor");if(!e)return;let t=0;Array.from(e.childNodes).forEach((n=>{(e=>{if(!e)return!0;if(e.nodeType===Node.TEXT_NODE)return""===e.textContent.trim();if(e.nodeType===Node.ELEMENT_NODE)return""===(e.innerText||e.textContent||"").trim();return!1})(n)&&(e.removeChild(n),t++)})),setStatus(`🧹 Removed ${t} visibly empty line(s).`)}function flattenParagraphsInEditor(){const e=document.getElementById("editor");if(!e)return void console.warn("Editor not found.");const t=Array.from(e.querySelectorAll("p"));let n=0;t.forEach((e=>{const t=document.createElement("span");for(;e.firstChild;)t.appendChild(e.firstChild);t.appendChild(document.createElement("br")),e.parentNode.replaceChild(t,e),n++})),setStatus(`📉 Flattened ${n} <p> elements to inline blocks.`)}function removeListFormattingNewlines(){const e=document.getElementById("editor");if(!e)return void console.warn("Editor not found.");let t=e.innerHTML;t=t.replace(/(<li[^>]*>)\s+/gi,"$1"),t=t.replace(/(<[ou]l[^>]*>)\s+/gi,"$1"),t=t.replace(/\s+<\/li>/gi,"</li>"),t=t.replace(/\s+<\/ol>/gi,"</ol>"),t=t.replace(/\s+<\/ul>/gi,"</ul>"),e.innerHTML=t,setStatus("✨ Cleaned up whitespace inside and around list elements.")}function removeAllAnnotations(){const e=document.getElementById("editor");if(!e)return void console.warn("Editor not found.");const t=["annotation","comment"].join(","),n=e.querySelectorAll(t);let o=0;n.forEach((e=>{e.remove(),o++})),setStatus(`❌ Removed ${o} annotation element(s).`)}function tidyUp(){removeAllAnnotations(),removeSpanContentsForClass("katex-html"),removeListFormattingNewlines(),removeEmptyLinesFromEditor(),flattenParagraphsInEditor(),removeAllButtonsFromEditor()}function logSelectedHTML(){const e=window.getSelection();if(!e||0===e.rangeCount)return void console.log("No selection.");const t=e.getRangeAt(0).cloneContents(),n=document.createElement("div");n.appendChild(t);const o=n.innerHTML;console.log("🔍 Selected HTML:"),console.log(o)}function logSpanContentsWithClass(e){const t=document.getElementById("editor");if(!t)return void console.warn("Editor element not found.");const n=t.querySelectorAll(`span.${e}`);0!==n.length?(console.log(`Found ${n.length} <span> elements with class "${e}":`),n.forEach(((e,t)=>{console.log("-----------------------------"),console.log(`[${t}]`,e.innerHTML)}))):console.log(`No <span> elements found with class "${e}".`)}function runFindReplace(){const e=document.getElementById("findPattern").value,t=document.getElementById("replaceText").value,n=document.getElementById("useRegex").checked,o=document.getElementById("caseSensitive").checked;document.getElementById("cursorOnlyMode").checked?(addCursorsAtRegex(e,n,o),hideFindReplaceDialog()):replace(e,t,n,o)}function addCursorsAtRegex(e,t=!1,n=!1){const o=document.getElementById("editor");clearCursorSpans();const r=[];let s;try{if(t)s=new RegExp(e,"g"+(n?"":"i"));else{const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s=new RegExp(t,"g"+(n?"":"i"))}}catch(e){return void setStatus("⚠️ Invalid regex pattern")}const l=[];let a,i="",c=0;for(!function e(t){if(t.nodeType===Node.TEXT_NODE){const e=t.textContent;""!==e.trim()&&l.push({node:t,start:c,end:c+e.length}),i+=e,c+=e.length}else if(t.nodeType===Node.ELEMENT_NODE)for(let n of t.childNodes)e(n)}(o);null!==(a=s.exec(i));){const e=a.index;for(const{node:t,start:n,end:o}of l)if(n<=e&&e<o){const o=e-n,s=document.createRange();s.setStart(t,o),s.collapse(!0),r.push({range:s,span:null});break}}cursors=r,updateCursorVisualPositions(),setStatus(`✅ ${r.length} cursor(s) added for pattern: ${s}`)}function replace(e,t,n=!0,o=!0){const r=document.getElementById("editor");if(!e)return void alert("Please enter a pattern to find.");const s=o?"g":"gi";let l;try{l=n?new RegExp(e,s):new RegExp(escapeRegex(e),s)}catch(e){return void alert("Invalid regular expression: "+e.message)}const a=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,null,!1),i=[];let c;for(;c=a.nextNode();)if(l.test(c.textContent)){const e=c.textContent.replace(l,t);i.push({node:c,newText:e})}i.forEach((({node:e,newText:t})=>{e.textContent=t})),hideFindReplaceDialog(),setStatus(`🔁 ${i.length} node(s) replaced.`)}function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function showFindReplaceDialog(){document.getElementById("findReplaceDialog").style.display="block"}function hideFindReplaceDialog(){document.getElementById("findReplaceDialog").style.display="none"}let speechUtterance=null;function speakSelection(){const e=window.getSelection();if(!e||0===e.rangeCount)return void alert("Please select some text to speak.");const t=e.toString().trim();t?(speechSynthesis.speaking&&speechSynthesis.cancel(),speechUtterance=new SpeechSynthesisUtterance(t),speechSynthesis.speak(speechUtterance),document.getElementById("stopSpeakingBtn").style.display="block",speechUtterance.onend=()=>{document.getElementById("stopSpeakingBtn").style.display="none",setStatus("🗣️ Finished reading aloud.")},setStatus("🗣️ Reading selected text...")):alert("Selected text is empty.")}function stopSpeaking(){speechSynthesis.speaking&&(speechSynthesis.cancel(),setStatus("⏹️ Speech stopped.")),document.getElementById("stopSpeakingBtn").style.display="none"}function getTextWithNewlinesFromRange(e){const t=e.cloneContents();let n="";return function e(t){if(t.nodeType===Node.TEXT_NODE)n+=t.textContent;else if(t.nodeType===Node.ELEMENT_NODE||t.nodeType===Node.DOCUMENT_FRAGMENT_NODE){const o=t.tagName?.toLowerCase();["div","p","br","li"].includes(o)&&(n+="\n"),t.childNodes.forEach(e),["div","p","li"].includes(o)&&(n+="\n")}}(t),n.replace(/\n{3,}/g,"\n\n").trim()}function getTextNodesWithOffsets(e){const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let n,o=[],r=0;for(;n=t.nextNode();)o.push({node:n,start:r,end:r+n.length}),r+=n.length;return o}function insertTextAtCursors(e){for(let t=cursors.length-1;t>=0;t--){const{range:n,span:o}=cursors[t],r=document.createTextNode(e);n.insertNode(r),n.setStartAfter(r),n.collapse(!0),r.parentNode&&r.parentNode.insertBefore(o,r.nextSibling)}}function insertCursorOnMouseDown(e){if(!cursorInsertMode)return;e.preventDefault();const t=document.caretRangeFromPoint?document.caretRangeFromPoint(e.clientX,e.clientY):document.caretPositionFromPoint(e.clientX,e.clientY)?.getRange();if(!t)return void console.warn("Could not determine click position");const n=document.createElement("span");n.className="cursor",t.insertNode(n),t.setStartAfter(n),t.collapse(!0),cursors.push({span:n,range:t}),setStatus(`🖱️ Cursor added. Total: ${cursors.length}`)}function clearAllCursors(){savedEditorRange.collapsed?(document.getElementById("editor").normalize(),document.querySelectorAll(".cursor").forEach((e=>e.remove())),document.getElementById("editor").normalize(),cursors=[],setStatus("❌ All cursors removed.")):removeCursorsInSelection()}function removeCursorsInSelection(){const e=savedEditorRange;if(e.collapsed)return void setStatus("⚠️ No selection — nothing removed.");const t=document.getElementById("editor"),n=[];cursors.forEach((o=>{const{range:r}=o;if(!t.contains(r.startContainer))return;const s=e.compareBoundaryPoints(Range.START_TO_START,r);e.compareBoundaryPoints(Range.END_TO_END,r)<=0||s>=0?n.push(o):null!=o.span&&(o.span.remove(),t.normalize())}));const o=cursors.length-n.length;cursors=n,updateCursorVisualPositions(),setStatus(`🧹 Removed ${o} cursor(s) inside selection.`)}function clearAllHighlight(){const e=document.getElementById("editor");function t(e){document.querySelectorAll(e).forEach((e=>{e.replaceWith(...e.childNodes)}))}e.normalize(),t(".highlight"),[1,2,3,4,5,6,7].forEach((e=>t(".highlight"+e))),e.normalize(),setStatus("❌ All highlights removed.")}let cursorInsertMode=!1;function toggleCursorInsertMode(){if(null!=savedEditorRange&&!savedEditorRange.collapsed)return void cursorsAtStart();cursorInsertMode=!cursorInsertMode,toggleMouseIconForCursorPlacementMode();document.getElementById("toggleCursorModeBtn").style.backgroundColor=cursorInsertMode?"#d3f":"",setStatus(cursorInsertMode?"🖱️ Click to add cursors":"🔚 Cursor mode off")}const toggleCursorModeButton=document.getElementById("toggleCursorModeBtn");toggleCursorModeButton.addEventListener("contextmenu",(e=>{e.preventDefault(),cursorsAtEnd()}));const alignButton=document.getElementById("alignWithCursorsBtn");function toggleMouseIconForCursorPlacementMode(){if(cursorInsertMode){const e='\n<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16">\n  <rect x="7" y="2" width="2" height="12" fill="black"/>\n  <rect x="2" y="7" width="12" height="2" fill="black"/>\n</svg>'.trim(),t=`url("data:image/svg+xml,${encodeURIComponent(e).replace(/'/g,"%27").replace(/"/g,"%22")}") 8 8, auto`;document.body.style.cursor=t}else document.body.style.cursor="text"}function moveCursors(e){const t=document.getElementById("editor"),n=[];clearCursorSpans(),cursors.forEach((({range:o})=>{let r=o.startContainer,s=o.startOffset;if(o.collapsed||(o.collapse("left"===e),r=o.startContainer,s=o.startOffset),r.nodeType!==Node.TEXT_NODE)if(r.childNodes.length>0&&r.childNodes[s])r=r.childNodes[s],s=0;else if(r.previousSibling&&"left"===e){for(r=r.previousSibling;r&&r.lastChild;)r=r.lastChild;s=r.textContent.length}else{if(!r.nextSibling||"right"!==e)return;for(r=r.nextSibling;r&&r.firstChild;)r=r.firstChild;s=0}if(!t.contains(r))return;if("left"===e)if(s>0)s--;else{let e=getPreviousTextNodeDeep(r);e&&(r=e,s=e.textContent.length-1,s=Math.max(s,0))}else if("right"===e)if(s<r.textContent.length)s++;else{let e=getNextTextNodeDeep(r);e&&(r=e,s=1)}s=Math.max(0,Math.min(s,r.textContent.length));const l=document.createRange();l.setStart(r,s),l.collapse(!0),n.push({range:l,span:null})})),cursors=n,updateCursorVisualPositions()}function alignWithCursors(){const e=document.getElementById("editor"),t=[];clearCursorSpans();[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range))).forEach((n=>{const o=n.range;if(!o.collapsed)return;let r=o.startContainer,s=o.startOffset;if(!e.contains(r))return;if(r.nodeType===Node.ELEMENT_NODE){if(r.childNodes[s]?.nodeType!==Node.TEXT_NODE)return;r=r.childNodes[s],s=0}if(r.nodeType===Node.TEXT_NODE){const e=r.textContent;if(s<e.length){const n=e.at(s);if(" "!=n&&"\t"!=n){const e=document.createRange();return e.setStart(r,s),e.collapse(!0),void t.push({range:e,span:null})}r.textContent=e.slice(0,s)+e.slice(s+1);const o=document.createRange();return o.setStart(r,s),o.collapse(!0),void t.push({range:o,span:null})}}let l=getNextTextNodeDeep(r);if(l&&l.textContent.length>0){const e=l.textContent.at(0);if(" "!=e&&"\t"!=e){const e=document.createRange();return e.setStart(r,s),e.collapse(!0),void t.push({range:e,span:null})}l.textContent=l.textContent.slice(1);const n=document.createRange();return n.setStart(l,0),n.collapse(!0),void t.push({range:n,span:null})}const a=document.createRange();a.setStart(r,s),a.collapse(!0),t.push({range:a,span:null})})),cursors=t,updateCursorVisualPositions()}function alignWithCursorsFromLeft(){const e=document.getElementById("editor"),t=[];clearCursorSpans();[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range))).forEach((n=>{const o=n.range;if(!o.collapsed)return;let r=o.startContainer,s=o.startOffset;if(!e.contains(r))return;if(r.nodeType===Node.ELEMENT_NODE){if(r.childNodes[s-1]?.nodeType!==Node.TEXT_NODE)return;r=r.childNodes[s-1],s=r.textContent.length}if(r.nodeType===Node.TEXT_NODE&&s>0){const e=r.textContent,n=e.at(s-1);if(" "!=n&&"\t"!=n){const e=document.createRange();return e.setStart(o.startContainer,o.startOffset),e.collapse(!0),void t.push({range:e,span:null})}r.textContent=e.slice(0,s-1)+e.slice(s);const l=document.createRange();return l.setStart(r,s-1),l.collapse(!0),void t.push({range:l,span:null})}const l=getPreviousTextNodeDeep(r);if(l&&l.textContent.length>0){const e=l.textContent,n=e.at(-1);if(" "!=n&&"\t"!=n){const e=document.createRange();return e.setStart(o.startContainer,o.startOffset),e.collapse(!0),void t.push({range:e,span:null})}const r=e.slice(0,-1);l.textContent=r;const s=document.createRange();return s.setStart(l,r.length),s.collapse(!0),void t.push({range:s,span:null})}const a=document.createRange();a.setStart(r,s),a.collapse(!0),t.push({range:a,span:null})})),cursors=t,updateCursorVisualPositions()}async function dd(e=1){const t=document.getElementById("editor"),n=savedEditorRange.cloneRange();if(!n.collapsed)return void setStatus("⚠️ No single cursor to delete from.");const o=n.getClientRects()[0];if(!o)return;const r=new Map,s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);for(;s.nextNode();){const e=s.currentNode;if(!e.textContent.trim())continue;const t=document.createRange();t.selectNodeContents(e);const n=t.getClientRects();for(const t of n){const n=Math.round(t.top);r.has(n)||r.set(n,[]),r.get(n).push(e)}}const l=Array.from(r.keys()).sort(((e,t)=>e-t)),a=Math.round(o.top),i=[];let c=!1;for(const t of l)if(!c&&t>=a&&(c=!0),c&&(i.push(...r.get(t)),0==--e))break;if(!i.length)return void setStatus("⚠️ No lines to delete.");const d=document.createRange();d.setStartBefore(i[0]),d.setEndAfter(i[i.length-1]);const u=document.createElement("div");u.appendChild(d.cloneContents()),u.querySelectorAll(".note-button").forEach((e=>{e.setAttribute("data-message",e.dataset.message)})),u.querySelectorAll("a[onclick]").forEach((e=>{const t=e.getAttribute("onclick")?.match(/selectText\(['"](.+?)['"]\)/);t&&e.setAttribute("data-select-id",t[1]),e.removeAttribute("onclick")}));const g=u.innerHTML,m=d.toString();try{await navigator.clipboard.write([new ClipboardItem({"text/plain":new Blob([m],{type:"text/plain"}),"text/html":new Blob([g],{type:"text/html"})})])}catch(e){return void setStatus("❌ Failed to copy before deletion")}d.deleteContents(),setStatus("🗑️ Deleted and yanked!")}async function yy(e=1){const t=document.getElementById("editor"),n=savedEditorRange.cloneRange();if(!n.collapsed)return void setStatus("⚠️ No single cursor to yank from.");const o=n.getClientRects()[0];if(!o)return;const r=new Map,s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);for(;s.nextNode();){const e=s.currentNode;if(!e.textContent.trim())continue;const t=document.createRange();t.selectNodeContents(e);const n=t.getClientRects();for(const t of n){const n=Math.round(t.top);r.has(n)||r.set(n,[]),r.get(n).push(e)}}const l=Array.from(r.keys()).sort(((e,t)=>e-t)),a=Math.round(o.top),i=[];let c=!1;for(const t of l)if(!c&&t>=a&&(c=!0),c&&(i.push(...r.get(t)),0==--e))break;if(!i.length)return void setStatus("⚠️ No lines to yank.");const d=document.createRange();d.setStartBefore(i[0]),d.setEndAfter(i[i.length-1]);const u=document.createElement("div");u.appendChild(d.cloneContents()),u.querySelectorAll(".note-button").forEach((e=>{e.setAttribute("data-message",e.dataset.message)})),u.querySelectorAll("a[onclick]").forEach((e=>{const t=e.getAttribute("onclick")?.match(/selectText\(['"](.+?)['"]\)/);t&&e.setAttribute("data-select-id",t[1]),e.removeAttribute("onclick")}));const g=u.innerHTML,m=d.toString();try{await navigator.clipboard.write([new ClipboardItem({"text/plain":new Blob([m],{type:"text/plain"}),"text/html":new Blob([g],{type:"text/html"})})]),setStatus("📋 Yanked!")}catch(e){setStatus("❌ Failed to copy to clipboard")}}function closeSearchResultPopup(){[1,2,3,4,5,6,7].forEach((e=>document.getElementById("searchResults"+e).style.display="none")),showTools()}function generateGUID(){return"xxxxxxxxxx".replace(/[x]/g,(()=>Math.floor(16*Math.random()).toString(16)))}function makeDraggable(e,t){const n=document.getElementById(e),o=document.getElementById(t);let r=0,s=0,l=0,a=0;function i(e){r=e.clientX-l,s=e.clientY-a,l=e.clientX,a=e.clientY;const t=n.getBoundingClientRect();n.style.top=t.top+s+"px",n.style.left=t.left+r+"px",n.style.transform=""}function c(){document.onmouseup=null,document.onmousemove=null}o.onmousedown=function(e){e.preventDefault(),l=e.clientX,a=e.clientY,document.onmouseup=c,document.onmousemove=i}}function getTextFromLastNewlineToRangeStart(e){const t=document.getElementById("editor"),n=document.createTreeWalker(t,NodeFilter.SHOW_ALL,null,!1),o=e.startContainer,r=e.startOffset,s=[];let l=!1;for(;n.nextNode();){const e=n.currentNode;if(e===o){l=!0,e.nodeType===Node.TEXT_NODE&&s.push(e.textContent.slice(0,r));break}if(!l)if(e.nodeType===Node.TEXT_NODE)s.push(e.textContent);else if(e.nodeType===Node.ELEMENT_NODE){const t=e.nodeName.toLowerCase();("br"===t||"p"===t||"div"===t||t.match(/^h[1-6]$/))&&s.push("\n")}}const a=s.join(""),i=a.lastIndexOf("\n");return-1!==i?a.slice(i+1):a}function getTextFromRangeEndToNextNewline(e){const t=document.getElementById("editor"),n=document.createTreeWalker(t,NodeFilter.SHOW_ALL,null,!1),o=e.endContainer,r=e.endOffset,s=[];let l=!1,a=!1;for(;n.nextNode()&&!a;){const e=n.currentNode;if(l){if(e.nodeType===Node.TEXT_NODE)s.push(e.textContent),e.textContent.includes("\n")&&(a=!0);else if(e.nodeType===Node.ELEMENT_NODE){const t=e.nodeName.toLowerCase();("br"===t||"p"===t||"div"===t||t.match(/^h[1-6]$/))&&(s.push("\n"),a=!0)}}else if(e===o&&(l=!0,e.nodeType===Node.TEXT_NODE)){const t=e.textContent.slice(r);s.push(t),t.includes("\n")&&(a=!0)}}const i=s.join(""),c=i.indexOf("\n");return-1!==c?i.slice(0,c):i}function removeAllButtonsFromEditor(){const e=document.getElementById("editor");if(!e)return;const t=e.querySelectorAll("button");t.forEach((e=>e.remove())),setStatus(`🧹 Removed ${t.length} button(s) from the editor.`)}function sanitizeHtml(){const e=document.getElementById("editor"),t=postProcessForEmail(e.innerHTML);e.innerHTML=t,setStatus("Editor content sanitized")}async function pasteSegmentsAcrossLines(){const e=document.getElementById("editor"),t=window.getSelection();if(!t||0===t.rangeCount)return void setStatus("No selection found.");const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))try{const t=await navigator.clipboard.read();let o="",r="";for(const e of t)if(e.types.includes("text/html")){const t=await e.getType("text/html");o=await t.text();break}o||(r=await navigator.clipboard.readText());const s=(o||r).split(/\r?\n|\r|<br\s*\/?>|<\/p>|<\/div>/i).map((e=>e.replace(/<[^>]+>/g,"").trim())).filter((e=>e.length>0));if(0===s.length)return void setStatus("Clipboard content is empty after splitting.");const l=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),a=[];for(;l.nextNode();){const e=l.currentNode;""!==e.textContent.trim()&&a.push(e)}let i=0,c=0,d=!1;for(const e of a){if(e===n.startContainer){i=c+n.startOffset,d=!0;break}c+=e.textContent.length}if(!d)return void setStatus("Couldn't locate cursor in text flow.");const u=[];let g=null,m=[];for(const e of a){const t=document.createRange();t.selectNodeContents(e);const n=Array.from(t.getClientRects());for(const t of n)(null===g||Math.abs(t.top-g)>2)&&(m.length>0&&u.push(m),m=[],g=t.top),m.push({node:e,offset:e.textContent.length})}m.length>0&&u.push(m);let f=-1;c=0;for(let e=0;e<u.length;++e){const t=u[e].reduce(((e,t)=>e+t.offset),0);if(i<=c+t){f=e;break}c+=t}if(-1===f)return void setStatus("Couldn't locate cursor line.");for(let e=0;e<s.length;++e){const t=u[f+e];if(!t)break;const n=t[t.length-1];n.node.textContent+=" "+s[e]}setStatus(`Pasted ${s.length} segment(s) line-wise.`)}catch(e){console.error(e),setStatus("Error accessing clipboard.")}else setStatus("Cursor is not inside the editor.")}async function pasteSegmentsAtLineStarts(){const e=document.getElementById("editor"),t=window.getSelection();if(!t||0===t.rangeCount)return void setStatus("No selection found.");const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))try{const t=await navigator.clipboard.read();let o="",r="";for(const e of t)if(e.types.includes("text/html")){const t=await e.getType("text/html");o=await t.text();break}o||(r=await navigator.clipboard.readText());const s=(o||r).split(/\r?\n|\r|<br\s*\/?>|<\/p>|<\/div>/i).map((e=>e.replace(/<[^>]+>/g,"").trim())).filter((e=>e.length>0));if(0===s.length)return void setStatus("Clipboard content is empty after splitting.");const l=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),a=[];for(;l.nextNode();){const e=l.currentNode;""!==e.textContent.trim()&&a.push(e)}let i=0,c=0,d=!1;for(const e of a){if(e===n.startContainer){i=c+n.startOffset,d=!0;break}c+=e.textContent.length}if(!d)return void setStatus("Couldn't locate cursor in text flow.");const u=[];let g=null,m=[];for(const e of a){const t=document.createRange();t.selectNodeContents(e);const n=Array.from(t.getClientRects());for(const t of n)(null===g||Math.abs(t.top-g)>2)&&(m.length>0&&u.push(m),m=[],g=t.top),m.push({node:e,offset:e.textContent.length})}m.length>0&&u.push(m);let f=-1;c=0;for(let e=0;e<u.length;++e){const t=u[e].reduce(((e,t)=>e+t.offset),0);if(i<=c+t){f=e;break}c+=t}if(-1===f)return void setStatus("Couldn't locate cursor line.");for(let e=0;e<s.length;++e){const t=u[f+e];if(!t)break;const n=t[0].node;n.textContent=s[e]+" "+n.textContent}setStatus(`Prepended ${s.length} segment(s) at line starts.`)}catch(e){console.error(e),setStatus("Error accessing clipboard.")}else setStatus("Cursor is not inside the editor.")}async function pasteHtmlAtCursors(){if(cursors&&0!==cursors.length)try{const e=await navigator.clipboard.read();let t=null;for(const n of e)if(n.types.includes("text/html")){const e=await n.getType("text/html");t=await e.text();break}if(!t)for(const n of e){for(const e of n.types)if(e.startsWith("image/")){const o=await n.getType(e);t=`<img src="${await blobToBase64(o)}" />`;break}if(t)break}if(t||(t=await navigator.clipboard.readText(),t&&(t=t.split(/\r?\n/).map((e=>`<div>${e}</div>`)).join(""))),!t||0===t.trim().length)return void setStatus("Clipboard is empty.");clearCursorSpans();const n=[],o=[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range)));for(const e of o){const o=e.range,r=document.createRange().createContextualFragment(t),s=r.lastChild;o.deleteContents(),o.insertNode(r);const l=document.createRange();s?.nodeType===Node.TEXT_NODE?l.setStart(s,s.length):l.setStartAfter(s),l.collapse(!0),n.push({range:l,span:null})}cursors=n,updateCursorVisualPositions(),setStatus(`Pasted into ${cursors.length} cursor(s).`)}catch(e){console.error(e),setStatus("Clipboard paste failed.")}else setStatus("No multi-cursors present.")}function blobToBase64(e){return new Promise(((t,n)=>{const o=new FileReader;o.onloadend=()=>t(o.result),o.onerror=n,o.readAsDataURL(e)}))}function explicitlySegmentLines(e){window.getSelection().removeAllRanges();const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];for(;t.nextNode();){const e=t.currentNode,o=e.textContent.length;for(let t=1;t<o;t++){const o=document.createRange(),r=document.createRange();o.setStart(e,t-1),o.setEnd(e,t),r.setStart(e,t),r.setEnd(e,t+1);const s=o.getBoundingClientRect(),l=r.getBoundingClientRect();Math.abs(l.top-s.top)>2&&n.push({node:e,offset:t})}}n.reverse().forEach((e=>{const t=document.createElement("br"),n=document.createRange();n.setStart(e.node,e.offset),n.collapse(!0),n.insertNode(t)}))}function getExplicitLines(e){explicitlySegmentLines(e);return e.innerHTML.split(/<br\s*\/?>/i)}function markCursors(){cursors.forEach((e=>{const t=document.createElement("span");t.className="cursor-marker",e.range.insertNode(t)}))}function extractCursorLines(e){const t=new Set;return e.forEach(((n,o)=>{n.includes('<span class="cursor-marker"></span>')&&(t.add(o),e[o]=n.replace(/<span class="cursor-marker"><\/span>/g,""))})),t}function restoreLines(e,t){e.innerHTML=t.join("<br>")}function keeplines(){const e=document.getElementById("editor");if(!cursors||0===cursors.length)return void setStatus("No cursors available.");markCursors();let t=getExplicitLines(e);const n=extractCursorLines(t);t=t.filter(((e,t)=>n.has(t))),restoreLines(e,t),cursors=[],setStatus("Kept only lines containing cursors.")}function dellines(){const e=document.getElementById("editor");if(!cursors||0===cursors.length)return void setStatus("No cursors available.");markCursors();let t=getExplicitLines(e);const n=extractCursorLines(t);t=t.filter(((e,t)=>!n.has(t))),restoreLines(e,t),cursors=[],setStatus("Deleted lines containing cursors.")}function reverseLines(){const e=document.getElementById("editor");let t=getExplicitLines(e);if(savedEditorRange.isCollapsed)t=t.reverse();else{const n=savedEditorRange,o=document.createElement("span"),r=document.createElement("span");o.id="selection-start",r.id="selection-end",n.insertNode(o),n.collapse(!1),n.insertNode(r),t=getExplicitLines(e);let s=t.findIndex((e=>e.includes('id="selection-start"'))),l=t.findIndex((e=>e.includes('id="selection-end"')));s>l&&([s,l]=[l,s]),t[s]=t[s].replace(/<span id="selection-start"><\/span>/g,""),t[l]=t[l].replace(/<span id="selection-end"><\/span>/g,"");const a=t.slice(0,s),i=t.slice(s,l+1).reverse(),c=t.slice(l+1);t=a.concat(i,c)}restoreLines(e,t),setStatus("Lines reversed successfully.")}function generateFileName(){if("string"==typeof currentFileName&&currentFileName.trim()){const e=currentFileName.trim();return e.endsWith(".html")||e.endsWith(".htm")?e:e+".html"}return`editor-content-${(new Date).toISOString().replace(/[:.]/g,"-")}.html`}alignButton.addEventListener("contextmenu",(e=>{e.preventDefault(),alignWithCursorsFromLeft()}));let lineNumbersShown=!1;function toggleLineNumbers(){const e=document.getElementById("editor");if(lineNumbersShown){return e.querySelectorAll("span.line-number").forEach((e=>e.remove())),lineNumbersShown=!1,void setStatus("Line numbers hidden.")}explicitlySegmentLines(e);const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];let o=null;for(;t.nextNode();){const e=t.currentNode,r=e.textContent;for(let t=0;t<r.length;t++){const r=document.createRange();r.setStart(e,t),r.setEnd(e,t+1);const s=r.getBoundingClientRect();if(0===s.height)continue;const l=Math.round(s.top);(null===o||Math.abs(l-o)>2)&&(n.push({node:e,offset:t}),o=l);break}}const r=String(n.length).length;n.forEach(((e,t)=>{const n=document.createElement("span");n.className="line-number",n.textContent=String(t+1).padStart(r,"0")+" ",n.style.fontFamily="monospace",n.style.color="gray",n.style.marginRight="0.5em";const o=document.createRange();o.setStart(e.node,e.offset),o.collapse(!0),o.insertNode(n)})),lineNumbersShown=!0,setStatus("Line numbers shown.")}function insertGeneratedTextAtCursors(e){if("function"!=typeof e)return void console.error("insertGeneratedTextAtCursors: parameter must be a function.");if(!cursors||0===cursors.length)return void setStatus("No multi-cursors present.");clearCursorSpans();const t=[...cursors].sort(((e,t)=>t.range.compareBoundaryPoints(Range.START_TO_START,e.range))),n=[];for(const o of t){const t=o.range,r=e(),s=document.createTextNode(r);t.deleteContents(),t.insertNode(s);const l=document.createRange();l.setStartAfter(s),l.collapse(!0),n.push({range:l,span:null})}cursors=n,updateCursorVisualPositions(),setStatus(`Inserted generated text at ${cursors.length} cursor(s).`)}function enumerateCursors(e=1){let t=e;insertGeneratedTextAtCursors((()=>`#${t++} `))}function getLinesWithHighlights(){explicitlySegmentLines(document.getElementById("editor"));const e=document.getElementById("editor").innerHTML.split(/<br\s*\/?>/i),t=new Set;return e.forEach(((e,n)=>{e.match(/<span class="highlight/)&&t.add(n)})),{lines:e,highlightedLines:t}}function keeplinesWithHighlights(){const e=document.getElementById("editor"),{lines:t,highlightedLines:n}=getLinesWithHighlights();if(0===n.size)return void setStatus("No highlighter spans found in any line.");const o=t.filter(((e,t)=>n.has(t)));e.innerHTML=o.join("<br>"),setStatus("Kept only lines containing highlights.")}function dellinesWithHighlights(){const e=document.getElementById("editor"),{lines:t,highlightedLines:n}=getLinesWithHighlights();if(0===n.size)return void setStatus("No highlighter spans found in any line.");const o=t.filter(((e,t)=>!n.has(t)));e.innerHTML=o.join("<br>"),setStatus("Deleted lines containing highlights.")}function insertDownloadLinkAtSavedRange(){const e=document.createElement("input");e.type="file",e.style.display="none",e.addEventListener("change",(function(){const t=e.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){const n=e.target.result,o=t.name,r=document.createElement("a");if(r.href=n,r.download=o,r.textContent=`📎${o}`,r.style.color="blue",r.style.textDecoration="underline",r.style.cursor="pointer",!savedEditorRange)return void setStatus("No saved editor range. Click in the editor first.");const s=document.createDocumentFragment();s.appendChild(r),s.appendChild(document.createTextNode(" "));const l=savedEditorRange.cloneRange();l.deleteContents(),l.insertNode(s),setStatus(`Inserted download link for ${o}`)},n.readAsDataURL(t)})),document.body.appendChild(e),e.click(),document.body.removeChild(e)}</script>
<div id=textPopup style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=popupTextAreaHeading>Text Input:</h4>
<textarea id=popupTextarea rows=12 cols=80 style=width:100%></textarea><br><br>
<button onclick=submitTextPopup()>OK</button>
<button onclick=closeTextPopup()>Cancel</button>
</div>
<div id=searchResults1 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults1Header style=cursor:move> Search Results 1: </h4>
<div id=searchResults1listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults2 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults2Header style=cursor:move> Search Results 2: </h4>
<div id=searchResults2listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults3 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults3Header style=cursor:move> Search Results 3: </h4>
<div id=searchResults3listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults4 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults4Header style=cursor:move> Search Results 4: </h4>
<div id=searchResults4listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults5 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults5Header style=cursor:move> Search Results 5: </h4>
<div id=searchResults5listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults6 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults6Header style=cursor:move> Search Results 6: </h4>
<div id=searchResults6listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=searchResults7 style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<h4 id=searchResults7Header style=cursor:move> Search Results 7: </h4>
<div id=searchResults7listing class=searchResultsListing></div>
<button onclick=closeSearchResultPopup()>Close</button>
</div>
<div id=stopRecordingPopup style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:9999">
<button onclick=stopRecording() id=stopBtn>⏹️ Stop</button>
</div>
<div id=jsEvalPopup style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;border:1px solid #ccc;padding:10px;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:10000">
<input id=jsEvalInput placeholder="Enter JS code..." style=width:300px>
</div>
<div id=scaleImagePopup style="display:none;position:fixed;top:25%;left:50%;transform:translateX(-50%);background:#fff;padding:15px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:10000">
<label for=scaleImageInput>Scale images (%):</label>
<input id=scaleImageInput onkeydown=scaleImagePressEnter(event) placeholder="e.g. 50" style=width:60px;margin-left:10px>
<button onclick=submitImageScaling()>OK</button>
<button onclick=closeScaleImagePopup()>Cancel</button>
</div>
<div id=helpPopup style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:10000;max-width:600px;max-height:80%;overflow-y:auto;font-family:monospace;font-size:14px">
<strong> Spectral Keystroke Commands </strong><button onclick=closeHelp()>Close</button><br>
<strong>Use '⌘' instead of 'Ctrl+Alt' on Mac</strong><pre>
  Ctrl+c         Copy
  Ctrl+x         Cut
  Ctrl+v         Paste
  Ctrl+s         Save file
  Ctrl+i         Insert HTML (e.g. for video embedding)
  Ctrl+m         Insert note
  Ctrl+l         Insert audio recording
  Ctrl+q or Esc  Javascript command evaluator popup
  Ctrl+b         Toggle toolbar visibility
  Ctrl+h         Show this help
  Ctrl+[1-7]     Send selected text to the n-th search box
  Ctrl+Alt+m     Match brackets (+ braces and parenthesis)
  Ctrl+Alt+p     Scale selected or nearby picture(s)
  Ctrl+Alt-s     Save state
  Ctrl+Alt+z     Undo to the last saved state
  Ctrl+Alt+y     Redo undone state reversal 
  Ctrl+Alt+c     Clear temporary highlighting
  Ctrl+Alt+v/V   Paste accross lines at starts(v)/ends(V)
  Ctrl+Alt+d     Delete lines with cursors
  Ctrl+Alt+k     Keep only lines with cursors
  Ctrl+Alt+D     Delete lines with highlighting
  Ctrl+Alt+K     Keep only lines with highlighting
  Ctrl+Alt+q     Add attachment
  Ctrl+Alt+s     Save editor content locally
  Tab            Indent selection
  Shift+Tab      Unindent selection
Text Commands (Can be used with Javascript Eval):
  wc           → Word count of selection
  reflow(n)    → Reflow selected text to n-character lines
  camel        → Convert identifier to camelCase
  snake        → Convert identifier to snake_case
  kebab        → Convert identifier to kebab-case
  uc           → Convert to upper case
  lc           → Convert to lowercase
  title        → Convert to Title Case
  darken       → Switch to dark mode
</pre></div>
<div id=awsConfigPopup style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;color:#000;padding:20px;border:1px solid #ccc;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:10000;font-family:sans-serif;font-size:14px;width:300px">
<h3>AWS S3 Configuration</h3>
<label>Access Key:</label><br>
<input id=awsAccessKey style=width:100%><br><br>
<label>Secret Access Key:</label><br>
<input type=password id=awsSecretKey style=width:100%><br><br>
<label>Region:</label><br>
<input id=awsRegion placeholder="e.g. us-east-1" style=width:100%><br><br>
<label>Bucket Name:</label><br>
<input id=awsBucket style=width:100%><br><br>
<label>Folder Name (prefix):</label><br>
<input id=awsFolder placeholder="e.g. editor-saves/" style=width:100%><br><br>
<button onclick=saveAWSConfig()>OK</button>
<button onclick='document.getElementById("awsConfigPopup").style.display="none"'>Cancel</button>
</div>
<div id=findReplaceDialog style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;border:1px solid #ccc;box-shadow:0 2px 10px rgba(0,0,0,.2);padding:20px;z-index:10000;width:320px;font-family:sans-serif;font-size:14px">
<h3>🔍 Find & Replace</h3>
<label>Find (pattern):</label><br>
<input id=findPattern style=width:100%><br><br>
<label>Replace with:</label><br>
<input id=replaceText style=width:100%><br><br>
<label><input type=checkbox id=useRegex checked> Use Regular Expression</label><br>
<label><input type=checkbox id=caseSensitive checked> Case Sensitive</label><br><br>
<label><input type=checkbox id=cursorOnlyMode> Place cursors only</label><br><br>
<button onclick=runFindReplace()>Replace All</button>
<button onclick=hideFindReplaceDialog()>Cancel</button>
</div>
<button id=stopSpeakingBtn onclick=stopSpeaking() style=display:none;position:fixed;bottom:20px;right:20px;background:#d33;color:#fff;border:none;border-radius:6px;padding:10px;font-size:14px;z-index:9999>
⏹️ Stop Speaking
</button>
</body>
</html>